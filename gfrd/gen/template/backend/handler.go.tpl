// Code generated by gfrd-gen. DO NOT EDIT.
// Table: {{ .Table.Name }} ({{ .Table.Comment }})

package {{ .Module }}

import (
	"context"

	"github.com/gogf/gf/v2/frame/g"
	"github.com/gogf/gf/v2/util/gconv"
{{- if or .HasCreatedAt .HasUpdatedAt .HasSoftDelete }}
	"github.com/gogf/gf/v2/os/gtime"
{{- end }}
)

// {{ .EntityName }}Handler {{ .Table.Comment }} Handler
type {{ .EntityName }}Handler struct{}

// {{ .EntityName }} {{ .Table.Comment }} Handler 实例
var {{ .EntityName }} = &{{ .EntityName }}Handler{}

{{- if .Features.list }}
// List {{ .Table.Comment }}列表
func (h *{{ .EntityName }}Handler) List(ctx context.Context, req *{{ .EntityName }}ListReq) (res *{{ .EntityName }}ListRes, err error) {
	m := g.Model("{{ .Table.Name }}").Ctx(ctx)

	// 构建查询条件
{{- range $field := $.Table.Columns }}
{{- if $field.IsQueryField }}
{{- if eq $field.TypeGo "string" }}
	if req.{{ $field.NamePascal }} != "" {
		m = m.Where("{{ $field.Name }}", req.{{ $field.NamePascal }})
	}
{{- else if eq $field.TypeGo "int" }}{{- if eq $field.QueryType "LIKE" }}
	if req.{{ $field.NamePascal }} != "" {
		m = m.WhereLike("{{ $field.Name }}", "%"+gconv.String(req.{{ $field.NamePascal }})+"%")
	}
{{- else }}
	if req.{{ $field.NamePascal }} > 0 {
		m = m.Where("{{ $field.Name }}", req.{{ $field.NamePascal }})
	}
{{- end }}
{{- else if eq $field.TypeGo "int64" }}
	if req.{{ $field.NamePascal }} > 0 {
		m = m.Where("{{ $field.Name }}", req.{{ $field.NamePascal }})
	}
{{- end }}
{{- end }}
{{- end }}

	total, err := m.Count()
	if err != nil {
		return nil, err
	}

	var list []*{{ .EntityName }}
	err = m.Page(req.Page, req.Size).OrderDesc("id").Scan(&list)
	if err != nil {
		return nil, err
	}

	return &{{ .EntityName }}ListRes{
		List:  list,
		Total: total,
	}, nil
}
{{- end }}

{{- if .Features.view }}
// View {{ .Table.Comment }}详情
func (h *{{ .EntityName }}Handler) View(ctx context.Context, req *{{ .EntityName }}ViewReq) (res *{{ .EntityName }}ViewRes, err error) {
	var data {{ .EntityName }}
	err = g.Model("{{ .Table.Name }}").Ctx(ctx).WherePri(req.Id).Scan(&data)
	if err != nil {
		return nil, err
	}

	return &{{ .EntityName }}ViewRes{Data: data}, nil
}
{{- end }}

{{- if .Features.add }}
// Add 添加{{ .Table.Comment }}
func (h *{{ .EntityName }}Handler) Add(ctx context.Context, req *{{ .EntityName }}AddReq) (err error) {
{{- if .HasCreatedAt }}
	req.CreatedAt = gtime.Now()
{{- end }}
{{- if .HasUpdatedAt }}
	req.UpdatedAt = gtime.Now()
{{- end }}

	_, err = g.Model("{{ .Table.Name }}").Ctx(ctx).Data(req).Insert()
	return err
}
{{- end }}

{{- if .Features.edit }}
// Edit 修改{{ .Table.Comment }}
func (h *{{ .EntityName }}Handler) Edit(ctx context.Context, req *{{ .EntityName }}EditReq) (err error) {
{{- if .HasUpdatedAt }}
	req.UpdatedAt = gtime.Now()
{{- end }}

	_, err = g.Model("{{ .Table.Name }}").Ctx(ctx).WherePri(req.Id).Data(req).Update()
	return err
}
{{- end }}

{{- if .Features.delete }}
// Delete 删除{{ .Table.Comment }}
func (h *{{ .EntityName }}Handler) Delete(ctx context.Context, req *{{ .EntityName }}DeleteReq) (err error) {
{{- if .HasSoftDelete }}
	// 软删除
	_, err = g.Model("{{ .Table.Name }}").Ctx(ctx).WherePri(req.Id).Data(g.Map{
		"deleted_at": gtime.Now(),
	}).Update()
{{- else }}
	_, err = g.Model("{{ .Table.Name }}").Ctx(ctx).WherePri(req.Id).Delete()
{{- end }}
	return err
}
{{- end }}
