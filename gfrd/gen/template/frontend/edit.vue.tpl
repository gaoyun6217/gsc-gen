<!-- Code generated by gfrd-gen. DO NOT EDIT. -->
<!-- Table: {{ .Table.Name }} ({{ .Table.Comment }}) -->

<script setup lang="ts">
import { ref, watch } from 'vue'
import { NModal, NForm, NFormItem, NInput, NButton, NSpace, useMessage } from 'naive-ui'
import type { {{ .EntityName }}, {{ .EntityName }}EditDTO } from '@/api/{{ .Module }}/{{ .EntityKebab }}/types'
import { {{ .EntityName }}Add, {{ .EntityName }}Edit } from '@/api/{{ .Module }}/{{ .EntityKebab }}'

interface Props {
  modelValue?: boolean
  data?: {{ .EntityName }} | null
}

const props = withDefaults(defineProps<Props>(), {
  modelValue: false,
  data: null,
})

const emit = defineEmits<{
  (e: 'update:modelValue', value: boolean): void
  (e: 'success'): void
}>()

const message = useMessage()
const modalVisible = ref(false)
const formRef = ref<any>(null)
const loading = ref(false)

// 表单数据
const formData = ref<{{ .EntityName }}EditDTO>({})

// 表单验证规则
const rules = {
{{- range $field := $.Table.Columns }}
{{- if and (ne $field.Name "id") (ne $field.Name "created_at") (ne $field.Name "updated_at") (ne $field.Name "deleted_at") }}
{{- if or $field.IsPrimary (contains (lower $field.Comment) "名称") (contains (lower $field.Comment) "账号") }}
  {{ $field.NameCamel }}: { required: true, message: '请输入{{ $field.Comment }}', trigger: 'blur' },
{{- end }}
{{- end }}
{{- end }}
}

// 监听弹窗显示
watch(
  () => props.modelValue,
  (val) => {
    modalVisible.value = val
    if (val && props.data) {
      // 编辑模式，填充表单数据
      formData.value = { ...props.data }
    } else {
      // 新增模式，重置表单
      formData.value = {}
    }
  },
  { immediate: true }
)

// 监听弹窗关闭
watch(modalVisible, (val) => {
  emit('update:modelValue', val)
})

// 提交表单
const handleSubmit = async () => {
  try {
    await formRef.value?.validate()
    loading.value = true

    if (formData.value.id) {
      // 编辑
      await {{ .EntityName }}Edit(formData.value as {{ .EntityName }}EditDTO)
      message.success('编辑成功')
    } else {
      // 新增
      await {{ .EntityName }}Add(formData.value as {{ .EntityName }}EditDTO)
      message.success('添加成功')
    }

    modalVisible.value = false
    emit('success')
  } catch (error: any) {
    message.error(error.message || '操作失败')
  } finally {
    loading.value = false
  }
}

// 打开弹窗
const open = (data?: {{ .EntityName }} | null) => {
  modalVisible.value = true
  if (data) {
    formData.value = { ...data }
  } else {
    formData.value = {}
  }
}

defineExpose({ open })
</script>

<template>
  <NModal
    v-model:show="modalVisible"
    preset="card"
    title="{{ .Table.Comment }} - {{ if .Features.edit }}编辑/新增{{ else }}新增{{ end }}"
    style="width: 600px"
    :close-on-esc="false"
  >
    <NForm
      ref="formRef"
      :model="formData"
      :rules="rules"
      label-placement="left"
      label-width:="100"
    >
{{- range $field := $.Table.Columns }}
{{- if and (ne $field.Name "id") (ne $field.Name "created_at") (ne $field.Name "updated_at") (ne $field.Name "deleted_at") }}
      <NFormItem label="{{ $field.Comment }}" path="{{ $field.NameCamel }}">
{{- if eq $field.FormType "textarea" }}
        <NInput
          v-model:value="formData.{{ $field.NameCamel }}"
          type="textarea"
          placeholder="请输入{{ $field.Comment }}"
          :maxlength="{{ $field.Length }}"
          show-count
        />
{{- else if eq $field.FormType "switch" }}
        <NSwitch v-model:value="formData.{{ $field.NameCamel }}" />
{{- else if eq $field.FormType "select" }}
        <NSelect
          v-model:value="formData.{{ $field.NameCamel }}"
          placeholder="请选择{{ $field.Comment }}"
          :options="[]"
        />
{{- else if eq $field.FormType "date" }}
        <NDatePicker v-model:value="formData.{{ $field.NameCamel }}" placeholder="请选择{{ $field.Comment }}" />
{{- else if eq $field.FormType "datetime" }}
        <NDatePicker
          v-model:value="formData.{{ $field.NameCamel }}"
          type="datetime"
          placeholder="请选择{{ $field.Comment }}"
          format="yyyy-MM-dd HH:mm:ss"
        />
{{- else }}
        <NInput
          v-model:value="formData.{{ $field.NameCamel }}"
          placeholder="请输入{{ $field.Comment }}"
          :maxlength="{{ if gt $field.Length 0 }}{{ $field.Length }}{{ else }}50{{ end }}"
        />
{{- end }}
      </NFormItem>
{{- end }}
{{- end }}
    </NForm>

    <template #footer>
      <NSpace justify="end">
        <NButton @click="modalVisible = false">取消</NButton>
        <NButton type="primary" :loading="loading" @click="handleSubmit">确定</NButton>
      </NSpace>
    </template>
  </NModal>
</template>
