<!-- Code generated by gfrd-gen. DO NOT EDIT. -->
<!-- Table: {{ .Table.Name }} ({{ .Table.Comment }}) -->

<script setup lang="ts">
import { ref, h } from 'vue'
import { NButton, NPopconfirm, NModal, NForm, NFormItem, NInput } from 'naive-ui'
import { BasicTable, type columnsType } from '@/components/BasicTable'
import { useCRUD } from '@/hooks/core/useCRUD'
import * as api from '@/api/{{ .Module }}/{{ .EntityKebab }}'
import type { {{ .EntityName }} } from '@/api/{{ .Module }}/{{ .EntityKebab }}/types'
import EditForm from './edit.vue'

const modalRef = ref<any>(null)

const {
  loading,
  data: list,
  total,
  fetchList,
  handleDelete,
} = useCRUD<{{ .EntityName }}>({
  api,
  message: { success: '操作成功', error: '操作失败' },
})

// 表格列配置
const columns: columnsType = [
{{- range $field := $.Table.Columns }}
{{- if and $field.IsListField (ne $field.Name "id") }}
  {
    title: '{{ $field.Comment }}',
    key: '{{ $field.NameCamel }}',
    width: {{ if eq $field.FormType "textarea" }}200{{ else if eq $field.FormType "datetime" }}180{{ else }}150{{ end }},
{{- if eq $field.FormType "switch" }}
    render: (row) => h('span', row.{{ $field.NameCamel }} ? '是' : '否'),
{{- else if eq $field.FormType "datetime" }}
    render: (row) => row.{{ $field.NameCamel }} ? String(row.{{ $field.NameCamel }}).substring(0, 10) : '-',
{{- end }}
  },
{{- end }}
{{- end }}
  {
    title: '操作',
    key: 'action',
    width: 180,
    fixed: 'right',
    render: (row: {{ .EntityName }}) => h('div', { style: { display: 'flex', gap: '8px' } }, [
      h(NButton, {
        size: 'small',
        type: 'primary',
        onClick: () => modalRef.value?.open(row),
      }, { default: () => '编辑' }),
      h(NPopconfirm, {
        onPositiveClick: () => handleDelete(row.id),
      }, {
        trigger: () => h(NButton, { size: 'small', type: 'error' }, { default: () => '删除' }),
        default: () => '确定删除吗？',
      }),
    ]),
  },
]

// 搜索表单
const searchFormRef = ref<any>(null)
const searchForm = ref({
{{- range $field := $.Table.Columns }}
{{- if $field.IsQueryField }}
  {{ $field.NameCamel }}: undefined as any,
{{- end }}
{{- end }}
})

const handleSearch = () => {
  fetchList(searchForm.value)
}

const handleReset = () => {
  searchFormRef.value?.restoreValidation()
  Object.keys(searchForm.value).forEach(key => {
    searchForm.value[key] = undefined
  })
  fetchList({})
}
</script>

<template>
  <n-card :bordered="false">
    <n-space vertical>
      <!-- 搜索表单 -->
      <n-form ref="searchFormRef" inline :model="searchForm" label-width="80">
        <n-flex>
{{- range $field := $.Table.Columns }}
{{- if $field.IsQueryField }}
          <n-form-item label="{{ $field.Comment }}" :path="'{{ $field.NameCamel }}'">
{{- if eq $field.FormType "input" }}
            <n-input v-model:value="searchForm.{{ $field.NameCamel }}" placeholder="请输入" clearable style="width: 200px" />
{{- else if eq $field.FormType "select" }}
            <n-select v-model:value="searchForm.{{ $field.NameCamel }}" placeholder="请选择" clearable style="width: 200px" />
{{- else if eq $field.FormType "date" }}
            <n-date-picker v-model:value="searchForm.{{ $field.NameCamel }}" placeholder="请选择" clearable style="width: 200px" />
{{- else }}
            <n-input v-model:value="searchForm.{{ $field.NameCamel }}" placeholder="请输入" clearable style="width: 200px" />
{{- end }}
          </n-form-item>
{{- end }}
{{- end }}
        </n-flex>
        <n-form-item>
          <n-space>
            <n-button type="primary" @click="handleSearch">查询</n-button>
            <n-button @click="handleReset">重置</n-button>
          </n-space>
        </n-form-item>
      </n-form>

      <!-- 数据表格 -->
      <BasicTable
        :columns="columns"
        :data="list"
        :loading="loading"
        :pagination="{ total, showSizeChanger: true, showQuickJumper: true }"
        :remote="true"
        @update:page="fetchList"
      >
        <template #tableTitle>
          <n-button type="primary" @click="modalRef?.open()">
            <template #icon>
              <svg-icon name="add" />
            </template>
            新增
          </n-button>
        </template>
      </BasicTable>
    </n-space>
  </n-card>

  <!-- 编辑弹窗 -->
  <EditForm ref="modalRef" @success="fetchList({})" />
</template>

<style scoped>
:deep(.n-form-item) {
  margin-bottom: 12px;
}
</style>
